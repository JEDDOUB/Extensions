{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "CityJSONExtension",
  "name": "Dynamizer",
  "uri": "https://raw.githubusercontent.com/JEDDOUB/Extensions/refs/heads/main/dynamizer-v2-structure.ext.json",
  "version": "1.1",
  "versionCityJSON": "2.0",
  "description": "Associate time-varying IoT observations (e.g., air quality) to CityJSON attributes via +Dynamizer.",
  "extraRootProperties": {},
  "extraAttributes": {
    "CityFurniture": {
      "+Dynamizer": { "$ref": "#/definitions/DynamizerOrArray" }
    },
    "GenericCityObject": {
      "+Dynamizer": { "$ref": "#/definitions/DynamizerOrArray" }
    }
  },
  "extraCityObjects": {},
  "extraSemanticSurfaces": {
    "CityFurniture": {
      "SensorMountSurface": {
        "description": "Surface or patch where a sensor is mounted.",
        "attributes": {
          "mountType": { "type": "string", "enum": ["arm", "bracket", "pole", "wall", "other"] },
          "exposure": { "type": "string", "enum": ["indoor", "outdoor"] },
          "heightAboveGround_m": { "type": "number", "minimum": 0 }
        }
      }
    },
    "GenericCityObject": {
      "SensorMountSurface": {
        "description": "Surface or patch where a sensor is mounted.",
        "attributes": {
          "mountType": { "type": "string", "enum": ["arm", "bracket", "pole", "wall", "other"] },
          "exposure": { "type": "string", "enum": ["indoor", "outdoor"] },
          "heightAboveGround_m": { "type": "number", "minimum": 0 }
        }
      }
    }
  },
  "definitions": {
    "DateTime": {
      "type": "string",
      "format": "date-time"
    },
    "URI": {
      "type": "string",
      "format": "uri"
    },
    "AttributeRef": {
      "type": "string",
      "minLength": 1,
      "description": "JSON Pointer-like path to the attribute being dynamized (e.g., 'attributes/NO2')."
    },
    "LinkObject": {
      "type": "object",
      "properties": {
        "uri": { "$ref": "#/definitions/URI" },
        "format": { "type": "string" },
        "headers": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "Optional HTTP headers (e.g., Authorization: Bearer ...)."
        },
        "query": {
          "type": "object",
          "additionalProperties": { "type": ["string", "number", "boolean"] },
          "description": "Optional query parameters to append to the URI."
        }
      },
      "required": ["uri"]
    },
    "SensorConnection": {
      "type": "object",
      "properties": {
        "sensorId": { "type": "string" },
        "serviceType": { "type": "string", "description": "e.g., 'OGC SensorThings', 'REST', 'SOS', 'OpenAQ'." },
        "linkToObservation": { "$ref": "#/definitions/LinkObject" },
        "linkToSensorDescription": { "$ref": "#/definitions/LinkObject" },
        "pollingIntervalSeconds": { "type": "integer", "minimum": 1 },
        "sensorLocation": {
          "type": "string",
          "description": "Optional hint about where the sensor sits (e.g., a related CityObject id/path)."
        }
      },
      "required": ["linkToObservation"]
    },
    "TimeseriesTimeValuePair": {
      "type": "object",
      "properties": {
        "type": { "const": "TimeseriesTimeValuePair" },
        "values": {
          "type": "array",
          "items": {
            "type": "array",
            "minItems": 2,
            "maxItems": 2,
            "items": [
              { "$ref": "#/definitions/DateTime" },
              { "type": "number" }
            ]
          }
        },
        "uom": { "type": "string" },
        "interpolation": {
          "type": "string",
          "enum": ["step", "linear", "spline"],
          "default": "step"
        }
      },
      "required": ["type", "values"]
    },
    "TimeseriesDomainRange": {
      "type": "object",
      "properties": {
        "type": { "const": "TimeseriesDomainRange" },
        "times": {
          "type": "array",
          "items": { "$ref": "#/definitions/DateTime" }
        },
        "values": {
          "type": "array",
          "items": { "type": "number" }
        },
        "uom": { "type": "string" }
      },
      "required": ["type", "times", "values"]
    },
    "ObservationData": {
      "type": "object",
      "properties": {
        "type": { "const": "ObservationData" },
        "observedProperty": { "type": "string", "description": "e.g., PM25, NO2, O3..." },
        "uom": { "type": "string" },
        "aggregation": { "type": "string", "description": "e.g., mean, max, min" },
        "statistic": { "type": "string" }
      },
      "required": ["type"]
    },
    "DynamicData": {
      "oneOf": [
        { "$ref": "#/definitions/TimeseriesTimeValuePair" },
        { "$ref": "#/definitions/TimeseriesDomainRange" },
        { "$ref": "#/definitions/ObservationData" }
      ]
    },
    "Dynamizer": {
      "type": "object",
      "properties": {
        "attributeRef": { "$ref": "#/definitions/AttributeRef" },
        "startTime": { "$ref": "#/definitions/DateTime" },
        "endTime": {
          "anyOf": [
            { "$ref": "#/definitions/DateTime" },
            { "type": "null" }
          ]
        },
        "dynamicData": { "$ref": "#/definitions/DynamicData" },
        "linkToSensor": { "$ref": "#/definitions/SensorConnection" },
        "metadata": {
          "type": "object",
          "additionalProperties": true,
          "description": "Optional free-form metadata (QA/QC flags, provider, calibration, etc.)."
        }
      },
      "required": ["attributeRef", "startTime", "dynamicData"],
      "additionalProperties": false
    },
    "DynamizerOrArray": {
      "oneOf": [
        { "$ref": "#/definitions/Dynamizer" },
        {
          "type": "array",
          "items": { "$ref": "#/definitions/Dynamizer" },
          "minItems": 1
        }
      ]
    }
  }
}
